generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Organization for multi-tenancy
model Organization {
  id   String @id @default(cuid())
  name String // 업체명
  slug String @unique // URL용 (예: "js-solar")

  plan           Plan @default(BASIC)
  sessionMaxDays Int  @default(60)

  users    User[]
  projects Project[]
  features OrganizationFeature[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OrganizationFeature {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  feature        Feature
  enabled        Boolean      @default(false)

  @@unique([organizationId, feature])
}

// NextAuth User model with role-based access
model User {
  id                 String            @id @default(cuid())
  username           String            @unique // 로그인 아이디
  name               String?
  email              String? // 이메일 (선택)
  emailVerified      DateTime?
  image              String?
  password           String? // Hashed password for credentials login
  role               UserRole          @default(CLIENT)
  organizationId     String?
  organization       Organization?     @relation(fields: [organizationId], references: [id])
  accounts           Account[]
  sessions           Session[]
  projectMemberships ProjectMember[]
  uploadedDocuments  DocumentVersion[]
  activities         Activity[]
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
}

// NextAuth Account model
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

// NextAuth Session model
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// NextAuth VerificationToken model (for magic link)
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Solar project information
model Project {
  id              String        @id @default(cuid())
  name            String
  description     String?       @db.Text
  location        String?
  capacityKw      Float? // Solar installation capacity in kW
  progressPercent Int           @default(0) // 0-100 (calculated from completed tasks)
  status          ProjectStatus @default(ACTIVE)
  organizationId  String
  organization    Organization  @relation(fields: [organizationId], references: [id])

  // 설비 정보
  moduleManufacturer String? // 모듈 제조사
  moduleModel        String? // 모듈 모델명
  moduleCapacity     String? // 모듈 용량 (예: 550W)
  moduleQuantity     Int? // 모듈 수량

  inverterManufacturer String? // 인버터 제조사
  inverterModel        String? // 인버터 모델명
  inverterCapacity     String? // 인버터 용량 (예: 50kW)
  inverterQuantity     Int? // 인버터 수량

  structureType         String? // 구조물 종류 (예: 고정식, 추적식)
  structureManufacturer String? // 구조물 제조사

  notes String? @db.Text // 기타 메모/비고

  members    ProjectMember[]
  documents  Document[]
  activities Activity[]
  tasks      ProjectTask[]
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
}

// Project task checklist
model ProjectTask {
  id           String     @id @default(cuid())
  projectId    String
  project      Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  taskType     TaskType
  customName   String? // Custom name (used when taskType is CUSTOM or for overriding default name)
  status       TaskStatus @default(NOT_STARTED)
  displayOrder Int // Display order
  note         String?    @db.Text
  completedAt  DateTime? // Completion date
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([projectId])
}

// Many-to-many relationship between Users and Projects
model ProjectMember {
  id           String   @id @default(cuid())
  userId       String?
  user         User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  projectId    String
  project      Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  invitedEmail String? // Email for invited users who haven't registered yet
  isOwner      Boolean  @default(false) // Project owner (사업주)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([userId, projectId])
  @@index([projectId])
  @@index([invitedEmail])
}

// Document metadata (versioned documents)
model Document {
  id               String            @id @default(cuid())
  projectId        String
  project          Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  category         DocumentCategory
  customCategory   String? // Custom category name (used when category is OTHER)
  title            String
  description      String?           @db.Text
  currentVersionId String?           @unique
  currentVersion   DocumentVersion?  @relation("CurrentVersion", fields: [currentVersionId], references: [id])
  versions         DocumentVersion[] @relation("DocumentVersions")
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  @@index([projectId])
  @@index([category])
}

// Document version history
model DocumentVersion {
  id                  String    @id @default(cuid())
  documentId          String
  document            Document  @relation("DocumentVersions", fields: [documentId], references: [id], onDelete: Cascade)
  currentVersionOfDoc Document? @relation("CurrentVersion")
  versionNumber       Int
  fileUrl             String
  fileName            String
  fileSizeBytes       Int?
  mimeType            String?
  note                String?   @db.Text
  uploadedById        String
  uploadedBy          User      @relation(fields: [uploadedById], references: [id])
  createdAt           DateTime  @default(now())

  @@unique([documentId, versionNumber])
  @@index([documentId])
}

// Activity log for project timeline
model Activity {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  type        String // e.g., "project_created", "document_uploaded", "phase_changed"
  title       String
  description String?  @db.Text
  metadata    Json? // Additional structured data
  createdAt   DateTime @default(now())

  @@index([projectId, createdAt])
}

// User roles
enum UserRole {
  SUPER_ADMIN // Super Administrator - cross-organization access
  ADMIN // Administrator - full access within organization
  CLIENT // Project owner (사업주) - read-only access
}

// Organization plans
enum Plan {
  BASIC
  PRO
  ENTERPRISE
}

// Organization features
enum Feature {
  DASHBOARD
  GANTT_CHART
  TASK_DETAIL
  AI_WEEKLY_REPORT
  PWA_PUSH
  VENDOR_MANAGEMENT
  BUDGET
  TELEGRAM_ALERT
}

// Project task types (checklist items)
enum TaskType {
  SITE_SURVEY // 현장실측/조사
  BUSINESS_PERMIT // 발전사업허가
  DEVELOPMENT_PERMIT // 개발행위허가
  CONTRACT // 도급계약
  STRUCTURE_DRAWING // 구조물도면/구조검토
  ELECTRICAL_DRAWING // 전기도면
  CONSTRUCTION_PLAN // 공사계획신고
  CONSTRUCTION // 시공
  PPA_APPLICATION // PPA신청
  PRE_USE_INSPECTION // 사용전검사
  DEVELOPMENT_COMPLETION // 개발행위준공
  BUSINESS_START // 사업개시신고
  FACILITY_CONFIRM // 설비확인
  CUSTOM // 커스텀 단계
}

// Project task status
enum TaskStatus {
  NOT_STARTED // 대기
  IN_PROGRESS // 진행중
  SUBMITTED // 접수
  COMPLETED // 완료
}

// Project status
enum ProjectStatus {
  ACTIVE
  COMPLETED
  ARCHIVED
}

// Document categories
enum DocumentCategory {
  CONTRACT // 계약서
  PERMIT // 인허가 서류
  DRAWING // 도면
  SCHEDULE // 공정표
  SITE_PHOTO // 현장 사진
  COMPLETION // 준공 서류
  OTHER // 기타
}
