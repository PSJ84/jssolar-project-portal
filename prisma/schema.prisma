generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Organization for multi-tenancy
model Organization {
  id   String @id @default(cuid())
  name String // 업체명
  slug String @unique // URL용 (예: "js-solar")

  plan           Plan @default(BASIC)
  sessionMaxDays Int  @default(60)

  // 조직 기본 템플릿 (없으면 시스템 기본 사용)
  defaultTemplateId String?

  users         User[]
  projects      Project[]
  features      OrganizationFeature[]
  taskTemplates  TaskTemplate[]
  quotations     Quotation[]

  // v2.5: 지식노트
  knowledgeNotes KnowledgeNote[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OrganizationFeature {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  feature        Feature
  enabled        Boolean      @default(false)

  @@unique([organizationId, feature])
}

// NextAuth User model with role-based access
model User {
  id                 String            @id @default(cuid())
  username           String            @unique // 로그인 아이디
  name               String?
  email              String? // 이메일 (선택)
  emailVerified      DateTime?
  image              String?
  password           String? // Hashed password for credentials login
  role               UserRole          @default(CLIENT)
  organizationId     String?
  organization       Organization?     @relation(fields: [organizationId], references: [id])
  accounts           Account[]
  sessions           Session[]
  projectMemberships ProjectMember[]
  uploadedDocuments  DocumentVersion[]
  activities         Activity[]
  assignedTasks             Task[]      @relation("TaskAssignee")
  statusChangedChecklists   Checklist[]

  // Todo relations
  assignedTodos             Todo[]      @relation("TodoAssignee")
  createdTodos              Todo[]      @relation("TodoCreatedBy")
  completedTodos            Todo[]      @relation("TodoCompletedBy")

  // Quotation relations
  createdQuotations         Quotation[]

  // v2.5: 지식노트
  knowledgeNotes            KnowledgeNote[]

  createdAt                 DateTime    @default(now())
  updatedAt          DateTime          @updatedAt
}

// NextAuth Account model
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

// NextAuth Session model
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// NextAuth VerificationToken model (for magic link)
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Solar project information
model Project {
  id              String        @id @default(cuid())
  name            String
  description     String?       @db.Text
  location        String?
  capacityKw      Float? // Solar installation capacity in kW
  progressPercent Int           @default(0) // 0-100 (calculated from completed tasks)
  status          ProjectStatus @default(ACTIVE)
  organizationId  String
  organization    Organization  @relation(fields: [organizationId], references: [id])

  // 설비 정보
  moduleManufacturer String? // 모듈 제조사
  moduleModel        String? // 모듈 모델명
  moduleCapacity     String? // 모듈 용량 (예: 550W)
  moduleQuantity     Int? // 모듈 수량

  inverterManufacturer String? // 인버터 제조사
  inverterModel        String? // 인버터 모델명
  inverterCapacity     String? // 인버터 용량 (예: 50kW)
  inverterQuantity     Int? // 인버터 수량

  structureType         String? // 구조물 종류 (예: 고정식, 추적식)
  structureManufacturer String? // 구조물 제조사

  notes String? @db.Text // 기타 메모/비고

  members      ProjectMember[]
  documents    Document[]
  activities   Activity[]
  projectTasks ProjectTask[]  // 레거시 (기존 프로젝트용)
  tasks        Task[]         // Phase 2 새 태스크 시스템
  todos        Todo[]         // 할 일 목록
  quotations   Quotation[]    // 연결된 견적서
  budgetItems  BudgetItem[]   // v2.5: 예산 관리 (품목 기반)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
}

// Project task checklist
model ProjectTask {
  id           String     @id @default(cuid())
  projectId    String
  project      Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  taskType     TaskType
  customName   String? // Custom name (used when taskType is CUSTOM or for overriding default name)
  status       TaskStatus @default(NOT_STARTED)
  displayOrder Int // Display order
  note         String?    @db.Text
  completedAt  DateTime? // Completion date
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([projectId])
}

// Many-to-many relationship between Users and Projects
model ProjectMember {
  id           String   @id @default(cuid())
  userId       String?
  user         User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  projectId    String
  project      Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  invitedEmail String? // Email for invited users who haven't registered yet
  isOwner      Boolean  @default(false) // Project owner (사업주)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([userId, projectId])
  @@index([projectId])
  @@index([invitedEmail])
}

// Document metadata (versioned documents)
model Document {
  id               String            @id @default(cuid())
  projectId        String
  project          Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  category         DocumentCategory
  customCategory   String? // Custom category name (used when category is OTHER)
  title            String
  description      String?           @db.Text
  currentVersionId String?           @unique
  currentVersion   DocumentVersion?  @relation("CurrentVersion", fields: [currentVersionId], references: [id])
  versions         DocumentVersion[] @relation("DocumentVersions")
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  @@index([projectId])
  @@index([category])
}

// Document version history
model DocumentVersion {
  id                  String    @id @default(cuid())
  documentId          String
  document            Document  @relation("DocumentVersions", fields: [documentId], references: [id], onDelete: Cascade)
  currentVersionOfDoc Document? @relation("CurrentVersion")
  versionNumber       Int
  fileUrl             String
  fileName            String
  fileSizeBytes       Int?
  mimeType            String?
  note                String?   @db.Text
  uploadedById        String
  uploadedBy          User      @relation(fields: [uploadedById], references: [id])
  createdAt           DateTime  @default(now())

  @@unique([documentId, versionNumber])
  @@index([documentId])
}

// Activity log for project timeline
model Activity {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  type        String // e.g., "project_created", "document_uploaded", "phase_changed"
  title       String
  description String?  @db.Text
  metadata    Json? // Additional structured data
  createdAt   DateTime @default(now())

  @@index([projectId, createdAt])
}

// User roles
enum UserRole {
  SUPER_ADMIN // Super Administrator - cross-organization access
  ADMIN // Administrator - full access within organization
  CLIENT // Project owner (사업주) - read-only access
}

// Organization plans
enum Plan {
  BASIC
  PRO
  ENTERPRISE
}

// Organization features
enum Feature {
  DASHBOARD
  GANTT_CHART
  TASK_DETAIL
  AI_WEEKLY_REPORT
  PWA_PUSH
  VENDOR_MANAGEMENT
  BUDGET
  TELEGRAM_ALERT
}

// Project task types (checklist items)
enum TaskType {
  SITE_SURVEY // 현장실측/조사
  BUSINESS_PERMIT // 발전사업허가
  DEVELOPMENT_PERMIT // 개발행위허가
  CONTRACT // 도급계약
  STRUCTURE_DRAWING // 구조물도면/구조검토
  ELECTRICAL_DRAWING // 전기도면
  CONSTRUCTION_PLAN // 공사계획신고
  CONSTRUCTION // 시공
  PPA_APPLICATION // PPA신청
  PRE_USE_INSPECTION // 사용전검사
  DEVELOPMENT_COMPLETION // 개발행위준공
  BUSINESS_START // 사업개시신고
  FACILITY_CONFIRM // 설비확인
  CUSTOM // 커스텀 단계
}

// Project task status
enum TaskStatus {
  NOT_STARTED // 대기
  IN_PROGRESS // 진행중
  SUBMITTED // 접수
  COMPLETED // 완료
}

// Project status
enum ProjectStatus {
  ACTIVE
  COMPLETED
  ARCHIVED
}

// Document categories
enum DocumentCategory {
  CONTRACT // 계약서
  PERMIT // 인허가 서류
  DRAWING // 도면
  SCHEDULE // 공정표
  SITE_PHOTO // 현장 사진
  COMPLETION // 준공 서류
  OTHER // 기타
}

// Checklist status
enum ChecklistStatus {
  PENDING // 대기
  REQUESTED // 요청함
  RECEIVED // 수령완료
  REVIEWING // 검토중
  REVISION // 보완필요
  COMPLETED // 완료
}

// Todo priority
enum TodoPriority {
  HIGH
  MEDIUM
  LOW
}

// Task phase for weighted progress calculation
enum TaskPhase {
  PERMIT        // 인허가/행정
  CONSTRUCTION  // 시공
  OTHER         // 기타
}

// ==================== Phase 2: 태스크 템플릿 ====================

model TaskTemplate {
  id          String  @id @default(cuid())
  name        String
  description String?
  sortOrder   Int     @default(0)

  // 시스템 기본 or 조직별
  isSystem       Boolean       @default(false)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // 계층 구조 (메인 태스크 → 하위 태스크)
  parentId String?
  parent   TaskTemplate?  @relation("TemplateHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children TaskTemplate[] @relation("TemplateHierarchy")

  checklistTemplates  ChecklistTemplate[]
  defaultAlertEnabled Boolean             @default(true)

  // 인허가 단계 설정
  isPermitTask   Boolean @default(false) // 인허가 여부
  processingDays Int?                     // 처리기한 (일)

  // v2.5: 진행률 가중치 단계
  phase TaskPhase @default(PERMIT)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isSystem, parentId, sortOrder])
  @@index([organizationId, parentId, sortOrder])
}

model ChecklistTemplate {
  id             String       @id @default(cuid())
  taskTemplateId String
  taskTemplate   TaskTemplate @relation(fields: [taskTemplateId], references: [id], onDelete: Cascade)
  name           String
  sortOrder      Int          @default(0)

  @@index([taskTemplateId, sortOrder])
}

// ==================== Phase 2: 실제 태스크 ====================

model Task {
  id        String  @id @default(cuid())
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // 계층 구조 (메인 태스크 → 하위 태스크)
  parentId String?
  parent   Task?  @relation("TaskHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children Task[] @relation("TaskHierarchy")

  // 원본 템플릿 추적
  originTemplateTaskId String?

  name        String
  description String?
  sortOrder   Int     @default(0)

  // 날짜 관리
  startDate     DateTime?
  dueDate       DateTime? // 인허가: 완료예정일 (접수일 + 처리기한)
  completedDate DateTime?

  // 인허가 단계 설정
  isPermitTask   Boolean   @default(false) // 인허가 여부
  processingDays Int?                       // 처리기한 (일)
  submittedDate  DateTime?                  // 접수일

  // 옵션
  alertEnabled Boolean @default(true)
  assigneeId   String?
  assignee     User?   @relation("TaskAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  memo         String? @db.Text
  isActive     Boolean @default(true) // 숨김/보임 토글

  // v2.5: 진행률 가중치 단계
  phase TaskPhase @default(PERMIT)

  // 낙관적 동시성 제어
  version Int @default(1)

  checklists Checklist[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([id, projectId])
  @@index([projectId, parentId, sortOrder])
  @@index([assigneeId, completedDate, dueDate])
  @@index([projectId, dueDate])
}

model Checklist {
  id     String @id @default(cuid())
  taskId String
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  name      String
  status    ChecklistStatus @default(PENDING)
  sortOrder Int             @default(0)

  statusChangedAt   DateTime?
  statusChangedById String?
  statusChangedBy   User?     @relation(fields: [statusChangedById], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([taskId, sortOrder])
}

// ==================== 할 일 (Todo) ====================

model Todo {
  id          String    @id @default(cuid())
  projectId   String
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  title       String
  description String?   @db.Text
  dueDate     DateTime?
  priority    TodoPriority @default(MEDIUM)

  assigneeId  String?
  assignee    User?     @relation("TodoAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)

  completedDate DateTime?
  completedById String?
  completedBy   User?   @relation("TodoCompletedBy", fields: [completedById], references: [id], onDelete: SetNull)

  createdById String
  createdBy   User      @relation("TodoCreatedBy", fields: [createdById], references: [id])

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([projectId, completedDate])
  @@index([assigneeId, completedDate])
  @@index([projectId, dueDate])
}

// ==================== 견적/수익분석 시스템 ====================

// 단가 카테고리
enum PriceCategory {
  MODULE      // 모듈
  INVERTER    // 인버터
  STRUCTURE   // 구조물
  LABOR       // 인건비/공사비
  ETC         // 기타
}

// 단가표
model PriceTable {
  id          String        @id @default(cuid())
  category    PriceCategory
  name        String        // "OO모듈 550W", "OO인버터 50kW"
  unit        String        // "장", "대", "kW", "식"
  unitPrice   Int           // 단가 (원)
  spec        String?       // 사양 정보
  isActive    Boolean       @default(true)
  sortOrder   Int           @default(0)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([category, isActive, sortOrder])
}

// 시스템 설정 (SMP, REC, 피크시간 등)
model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique  // "SMP_PRICE", "REC_PRICE", "PEAK_HOURS", etc
  value       String            // JSON 또는 단일값
  description String?
  updatedAt   DateTime @updatedAt
}

// 견적 상태
enum QuotationStatus {
  DRAFT       // 작성중
  SENT        // 발송됨
  ACCEPTED    // 수락됨 (계약)
  REJECTED    // 거절됨
  EXPIRED     // 만료됨
}

// 견적서
model Quotation {
  id              String          @id @default(cuid())
  quotationNumber String          @unique  // "Q-2024-001"
  version         Int             @default(1)

  // 고객 정보
  customerName    String            // 수신 (고객명)
  customerAddress String?           // 고객 주소
  customerPhone   String?
  customerEmail   String?
  address         String?           // 레거시 호환용

  // 프로젝트 정보
  projectName     String?           // 건명

  // 견적 정보
  quotationDate   DateTime @default(now())  // 일자
  validUntil      DateTime?         // 유효기간
  specialNotes    String?  @db.Text // 특기사항

  // 설치 정보 (레거시 호환용)
  capacityKw      Float?
  moduleType      String?
  moduleCount     Int?
  inverterType    String?
  inverterCount   Int?
  structureType   String?

  // 금액
  subtotal        Int      @default(0)  // 소계
  roundingType    String   @default("NONE")  // NONE, THOUSAND, TEN_THOUSAND
  roundingAmount  Int      @default(0)  // 잔액정리 금액
  totalAmount     Int      @default(0)  // 합계
  vatAmount       Int      @default(0)  // VAT (레거시 호환)
  grandTotal      Int      @default(0)  // 총 금액 (레거시 호환)
  vatIncluded     Boolean  @default(false)  // 부가세 포함 여부

  // 실행견적 합계 (내부용)
  execSubtotal    Int?
  execTotal       Int?

  // 상태
  status          QuotationStatus @default(DRAFT)

  // 견적 상세 항목
  items           QuotationItem[]

  // 수익분석
  analyses        ProfitAnalysis[]

  // 프로젝트 연결 (계약 시)
  projectId       String?
  project         Project?        @relation(fields: [projectId], references: [id], onDelete: SetNull)

  // 조직
  organizationId  String
  organization    Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdById     String
  createdBy       User            @relation(fields: [createdById], references: [id])
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([organizationId, status])
  @@index([quotationNumber])
  @@index([createdById])
}

// 견적 항목
model QuotationItem {
  id            String    @id @default(cuid())
  quotationId   String
  quotation     Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)

  name          String            // 품명 및 규격
  unit          String  @default("식")  // 단위 (EA, 식, kW, m, m², SET, LOT)
  quantity      Float   @default(1)     // 수량
  unitPrice     Int     @default(0)     // 단가
  amount        Int     @default(0)     // 금액 (수량 * 단가)
  note          String? // 비고

  // 실행견적 (내부용)
  execUnitPrice Int?              // 실행단가
  execAmount    Int?              // 실행금액

  // 레거시 호환
  category      String?   // MODULE, INVERTER, etc
  spec          String?

  sortOrder     Int     @default(0)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([quotationId, sortOrder])
}

// 금융 모델
enum FinancingType {
  SELF_FUNDING      // 자부담 100%
  BANK_LOAN         // 은행 80% 대출
  GOVERNMENT_LOAN   // 금융지원사업
  FACTORING         // 팩토링
}

// 수익분석
model ProfitAnalysis {
  id              String        @id @default(cuid())
  quotationId     String
  quotation       Quotation     @relation(fields: [quotationId], references: [id], onDelete: Cascade)

  // 금융 모델
  financingType   FinancingType

  // 입력값
  totalInvestment Int           // 총 투자금
  selfFundingRate Float         // 자부담 비율 (0~1)
  loanAmount      Int           // 대출금
  interestRate    Float         // 금리 (%)
  loanPeriod      Int           // 대출 기간 (년)
  gracePeriod     Int           @default(0)  // 거치 기간 (년)

  // 팩토링 수수료
  guaranteeFeeRate  Float?      // 보증료율 (서울보증)
  factoringFeeRate  Float?      // 팩토링 수수료율 (동부화재)

  // 발전 설정
  peakHours         Float       // 피크시간 (3.6~3.7)
  degradationRate   Float       // 효율저하율 (0.008)

  // 단가
  smpPrice          Int         // SMP 단가
  recPrice          Int         // REC 단가
  recWeight         Float       // REC 가중치

  // 연간 비용
  maintenanceCost   Int         // 안전관리비
  monitoringCost    Int         // 모니터링비

  // 결과 (20년 데이터 JSON)
  yearlyData        Json        // [{year, generation, revenue, expense, netProfit, cumulative}]

  // 요약
  paybackPeriod     Float       // 회수 기간 (년)
  totalProfit20y    Int         // 20년 총 수익
  roi               Float       // ROI (%)

  createdAt         DateTime    @default(now())

  @@index([quotationId])
}

// ==========================================
// v2.5 통합 솔루션 시스템
// ==========================================

// 지식노트 카테고리
enum KnowledgeCategory {
  CONSTRUCTION  // 시공노하우
  PERMIT        // 인허가팁
  MATERIAL      // 자재정보
  REGULATION    // 법규
  CONTACT       // 연락처
  OTHER         // 기타
}

// 예산 타입 (매출/매입)
enum BudgetType {
  INCOME    // 매출 (수입)
  EXPENSE   // 매입 (지출)
}


// 지식노트
model KnowledgeNote {
  id          String            @id @default(cuid())
  title       String
  content     String            @db.Text
  category    KnowledgeCategory
  tags        String[]          // 태그 배열
  isPinned    Boolean           @default(false)

  organizationId String
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdById    String
  createdBy      User            @relation(fields: [createdById], references: [id])

  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  @@index([organizationId, category])
  @@index([organizationId, isPinned])
}


// 예산 품목 (계획)
model BudgetItem {
  id            String   @id @default(cuid())
  projectId     String
  project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  type          BudgetType        // INCOME / EXPENSE
  category      String            // "도급계약", "구조물자재", "전기공사" 등
  plannedAmount Int               // 계획 금액 (공급가액)
  vatIncluded   Boolean  @default(false)  // 부가세 포함 여부
  memo          String?           // 메모
  sortOrder     Int      @default(0)

  transactions  BudgetTransaction[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([projectId, type])
}

// 거래 내역 (건별)
model BudgetTransaction {
  id            String     @id @default(cuid())
  budgetItemId  String
  budgetItem    BudgetItem @relation(fields: [budgetItemId], references: [id], onDelete: Cascade)

  date          DateTime          // 거래일
  description   String            // "계약금", "중도금", "잔금", "추가비용" 등
  amount        Int               // 금액 (공급가액, 음수 가능 - 환불/조정)
  vatIncluded   Boolean  @default(false)  // 부가세 포함 여부
  isCompleted   Boolean  @default(true)  // 완료=true, 예정=false

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([budgetItemId, date])
}
